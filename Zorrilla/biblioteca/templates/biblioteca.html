{% extends 'base.html' %}
{% load static %}
{% block navbar %}
{% endblock navbar %}
{% block body %}

{% load poll_extras %}

<div class="sidenav">
    <h1 align="center" class="text-white">Indice</h1>
  
    <button class="dropdown-btn">Alfabeticamente<i class="fa fa-caret-down"></i></button>
    <div class="dropdown-container">
      <a href="{% url 'filtered_books' 'title' 5 %}">5 libros</a>
      <a href="{% url 'filtered_books' 'title' 10 %}">10 libros</a>
      <a href="{% url 'filtered_books' 'title' 25 %}">25 libros</a>
      <a href="{% url 'filtered_books' 'title' 50 %}">50 libros</a>
      <a href="{% url 'filtered_books' 'title' 100 %}">100 libros</a>
    </div>
    <button class="dropdown-btn">Fecha de Lanzamiento<i class="fa fa-caret-down"></i></button>
    <div class="dropdown-container">
      <a href="{% url 'filtered_books' 'fecha_lanzamiento' 5 %}">5 libros</a>
      <a href="{% url 'filtered_books' 'fecha_lanzamiento' 10 %}">10 libros</a>
      <a href="{% url 'filtered_books' 'fecha_lanzamiento' 25 %}">25 libros</a>
      <a href="{% url 'filtered_books' 'fecha_lanzamiento' 50 %}">50 libros</a>
      <a href="{% url 'filtered_books' 'fecha_lanzamiento' 100 %}">100 libros</a>
    </div>
    <button class="dropdown-btn">Genero<i class="fa fa-caret-down"></i></button>
    <div class="dropdown-container">
      <a href="{% url 'filtered_books' 'genero' 5 %}">5 libros</a>
      <a href="{% url 'filtered_books' 'genero' 10 %}">10 libros</a>
      <a href="{% url 'filtered_books' 'genero' 25 %}">25 libros</a>
      <a href="{% url 'filtered_books' 'genero' 50 %}">50 libros</a>
      <a href="{% url 'filtered_books' 'genero' 100 %}">100 libros</a>
    </div>
    {% if request.user|has_group:"Director" %} 
        <button class="dropdown-btn">Deshabilitado<i class="fa fa-caret-down"></i></button>
        <div class="dropdown-container">
          <a href="{% url 'libros_habilitados' 5 %}">5 libros</a>
          <a href="{% url 'libros_habilitados' 10 %}">10 libros</a>
          <a href="{% url 'libros_habilitados' 25 %}">25 libros</a>
          <a href="{% url 'libros_habilitados' 50 %}">50 libros</a>
          <a href="{% url 'libros_habilitados' 100 %}">100 libros</a>
        </div>
    {% endif %}
    <a href="{% url 'all_the_books' %}">Todos</a>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    {% if request.user|has_group:"Director" %}
        <button class="btn btn-dark boton_informe btn-lg btn-block" onclick="informe('{% url 'informe' %}')">Informe</button>
    {% endif %}
    {% if user.is_authenticated %}
        <button class="btn btn-success boton_cargar btn-lg btn-block"  data-toggle="modal" data-target="#myModal">Añadir libro</button>
    {% endif %}

  </div>

  
  
<div class="main">

    <br>
    <center><h2>BIBLIOTECA</h2></center>
    <br>
    
  <div class="container">
    <div class="row">
      <div class="">
        <input type="text"placeholder="Nombre del libro que desee buscar" id="myInput" onkeyup="myFunction()">
        <select id="filter_by">
            <option value=0>Titulo</option>
            <option value=1>Descripción</option>
            <option value=2>Fecha</option>
        </select>
      </div>   
  </div>
  </div>
  <div class="container">
      <div class="row">
          <div class="col-md-12">
          <h4></h4>
          <div class="table-responsive">


  <table id="mytable" class="table table-hover">

    <thead>
        <th onclick="sortTable(0)">Titulo</th>
        <th onclick="sortTable(1)">Descripción</th>
        <th onclick="sortTable(2)">Fecha</th>
        <th>Info</th>
        {% if user.is_authenticated %}
            <th>Borrar</th>
        {% endif %}
        <th>Ver Libro</th>
        {% if request.user|has_group:"Director" %}
            <th>Historia</th>
        {% endif %}
        {% if request.user|has_group:"Director" %}
            <th>Estado</th>
        {% endif %}
    </thead>
    <tbody>
        {% for doc in documentos %}
            <tr>
                <td>{{doc.title}}</td>
                <td>{{doc.description}}</td>
                <td>{{doc.uploaded_at}}</td>
                <td><button class="btn btn-info" onclick="info_libro('{% url 'info_libro' doc.id %}', {{doc.id}})" id="info_book">
                <i style="font-size:15px" class="fa">&#xf013;</i></button></td>
                {% if user.is_authenticated %}
                    <td><button class="btn btn-danger" onclick="eliminar_libro('{% url 'eliminar_libro' doc.id %}', {{doc.id}})" id="delete_book">
                    <i style="font-size:15px" class="fa">&#xf00d;</i></button></td>
                {% endif %}
                <td><a type="button" class="btn btn-outline-primary" href="{{ doc.document.url }}">Abrir</a></td>
                {% if request.user|has_group:"Director" %} 
                    <td><button class="btn btn-primary" onclick="historia_libro('{% url 'historia_libro' doc.id %}', {{doc.id}})" id="delete_book">
                    <i style="font-size:15px" class="fa">&#xf05a;</i></button></td>
                    <td><button class="btn btn-primary" onclick="deshabilitar_libro('{% url 'cambiar_estado_libro' doc.id %}', {{doc.id}})" id="delete_book"><i style="font-size:15px" class="fa">&#xf05a;</i></button></td>
                {% endif %}
            </tr>
          {% endfor %}
      </tbody>
  </table>
              
      <div id="snackbar"><span id="span_result"></span></div>
              
      <!-- The Modal -->
      <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="edit" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h4 class="font-weight-bold" id="Heading">Cargar Libro</h4>            
                <button type="button" class="close" data-dismiss="modal">X</button>
              </div>
              <div class="modal-body">
                  <form method="post" enctype="multipart/form-data" id="form_for_book">
                    {% csrf_token %}

                    <div class="form-group">
                        <label class="form_biblo" >Descripcion:</label>
                        <div>
                          {{ form.description }}
                        </div>
                    </div>


                    <div class="form-group">
                      <label class="form_biblo">Elija un archivo:</label>
                      <div style="margin-left: 3%;">
                          {{form.document}}
                      </div>
                    </div>


                    <div class="form-group">
                      <label class="form_biblo">Titulo:</label>
                      <div>
                        {{ form.title}}
                      </div>
                    </div>

                    <div class="form-group">
                      <label class="form_biblo">Genero:</label>
                      <div style="margin-left: 3%;">
                        {{ form.genero}}
                      </div>
                    </div>
                      <span id="estado" style="color:red"></span>

                  <!-- Modal footer -->
                  </div>
                    </form>
              <button class="btn btn-success" align="center"  onclick="load_book()">Cargar</button>
                </div>
              </div>
            </div>
        </div>
      

    <div class="modal fade" id="modal_info">
        <div id="datos_modal">
        </div>
    </div>
              
    <div class="modal fade" id="modal_historia">
        <div id="modal_historia_info">
        </div>
    </div>
              
    <div class="modal fade" id="modal_estadistica">
        <div id="modal_estadistica_info">
        </div>
    </div>

<script>
    
    function updateDiv()
    {
      $( "#mytable" ).load(window.location.href + " #mytable" );
    }
        
    function load_book(){
        var myForm = document.getElementById('form_for_book');
        formData = new FormData(myForm);
        $.ajax({
            url: '/cargado/',
            data: formData,
            processData: false,
            contentType: false,
            type: 'POST',
            success: function(data){
                console.log(data.error);
                if (data.error){
                    var x = document.getElementById("estado");
                    estado.innerHTML = data.estado
                }else{
                    var x = document.getElementById("myModal");
                    $(x).modal('hide');
                    updateDiv();
                    var y = document.getElementById("snackbar");
                    y.className = "show";
                    document.getElementById("span_result").innerHTML = data.estado;
                    setTimeout(function(){ y.className = y.className.replace("show", ""); }, 2000);
                }
            }
        });
    }
    
function sortTable(n) {
    var table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
    table = document.getElementById("mytable");
    switching = true;
    //Set the sorting direction to ascending:
    dir = "asc";
    /*Make a loop that will continue until
    no switching has been done:*/
    while (switching) {
        //start by saying: no switching is done:
        switching = false;
        rows = table.getElementsByTagName("TR");
        /*Loop through all table rows (except the
        first, which contains table headers):*/
        for (i = 1; i < (rows.length - 1); i++) {
            //start by saying there should be no switching:
            shouldSwitch = false;
            /*Get the two elements you want to compare,
            one from current row and one from the next:*/
            x = rows[i].getElementsByTagName("TD")[n];
            y = rows[i + 1].getElementsByTagName("TD")[n];
            /*check if the two rows should switch place,
            based on the direction, asc or desc:*/
            if (dir == "asc") {
                if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
                    //if so, mark as a switch and break the loop:
                    shouldSwitch= true;
                break;
                }
          } else if (dir == "desc") {
            if (x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()) {
              //if so, mark as a switch and break the loop:
              shouldSwitch = true;
              break;
            }
          }
    }
    if (shouldSwitch) {
      /*If a switch has been marked, make the switch
      and mark that a switch has been done:*/
      rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
      switching = true;
      //Each time a switch is done, increase this count by 1:
      switchcount ++;
    } else {
      /*If no switching has been done AND the direction is "asc",
      set the direction to "desc" and run the while loop again.*/
      if (switchcount == 0 && dir == "asc") {
        dir = "desc";
        switching = true;
      }
    }
  }
}

function myFunction() {
  var e = document.getElementById("filter_by");
  var strUser = e.options[e.selectedIndex].value;
  var input, filter, table, tr, td, i;
  input = document.getElementById("myInput");
  filter = input.value.toUpperCase();
  table = document.getElementById("mytable");
  tr = table.getElementsByTagName("tr");
  for (i = 0; i < tr.length; i++) {
    td = tr[i].getElementsByTagName("td")[strUser];
    if (td) {
      if (td.innerHTML.toUpperCase().indexOf(filter) > -1) {
        tr[i].style.display = "";
      } else {
        tr[i].style.display = "none";
      }
    }
  }
}



function eliminar_libro(url, alum) {
  var r = confirm("Eliminar Libro ?");
  if (r == true) {
    $.ajax({
      method: "POST",
      url: url,
      data: {
        csrfmiddlewaretoken: '{{ csrf_token }}'
      }
    })
    .done(function (data) {
      var y = document.getElementById("snackbar");
      y.className = "show";
      document.getElementById("span_result").innerHTML = data.estado;
      setTimeout(function(){ y.className = y.className.replace("show", ""); }, 2000);
      updateDiv();
    });
  } else {
    return;
  }

};

function deshabilitar_libro(url, alum) {
  var r = confirm("Cambiar Estado del Libro ?");
  if (r == true) {
    $.ajax({
      method: "POST",
      url: url,
      data: {
        csrfmiddlewaretoken: '{{ csrf_token }}'
      }
    })
    .done(function (data) {
      var y = document.getElementById("snackbar");
      y.className = "show";
      document.getElementById("span_result").innerHTML = data.estado;
      setTimeout(function(){ y.className = y.className.replace("show", ""); }, 2000);
      updateDiv();
    });
  } else {
    return;
  }

};

function info_libro(url, alum) {
    $.ajax({
        method: "POST",
        url: url,
        data: {
            csrfmiddlewaretoken: '{{ csrf_token }}'
        }
    })
    .done(function (data) {
        console.log("llega");
        $("#datos_modal").html(data);
        $('#modal_info').modal('show'); 
    });
};
   
function informe(url) {
    $.ajax({
        method: "POST",
        url: url,
        data: {
            csrfmiddlewaretoken: '{{ csrf_token }}'
        }
    })
    .done(function (documentos) {
        $("#modal_estadistica_info").html(documentos);
        $('#modal_estadistica').modal('show'); 
    });
};
  
function historia_libro(url, alum) {
    $.ajax({
        method: "POST",
        url: url,
        data: {
            csrfmiddlewaretoken: '{{ csrf_token }}'
        }
    })
    .done(function (data) {
        $("#modal_historia_info").html(data);
        $('#modal_historia').modal('show'); 
    });
};

/* Loop through all dropdown buttons to toggle between hiding and showing its dropdown content - This allows the user to have multiple dropdowns without any conflict */
var dropdown = document.getElementsByClassName("dropdown-btn");
var i;
for (i = 0; i < dropdown.length; i++) {
  dropdown[i].addEventListener("click", function() {
    this.classList.toggle("active");
    var dropdownContent = this.nextElementSibling;
    if (dropdownContent.style.display === "block") {
      dropdownContent.style.display = "none";
    } else {
      dropdownContent.style.display = "block";
    }
  });
}

</script>



</html>
{% endblock body %}
